<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB + MySQL Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 20px;
            border-radius: 50px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
            box-shadow: 0 0 10px #48bb78;
        }

        .status-indicator.offline {
            background: #f56565;
            box-shadow: 0 0 10px #f56565;
        }

        .status-indicator.syncing {
            background: #ed8936;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pending-badge {
            background: #4299e1;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            color: #333;
            font-size: 1.5em;
        }

        .badge {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #4299e1;
            color: white;
        }

        .btn-info:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .btn-purple {
            background: #9f7aea;
            color: white;
        }

        .btn-purple:hover {
            background: #805ad5;
            transform: translateY(-2px);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
        }

        .table tr:hover {
            background: #f7fafc;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert-warning {
            background: #feebc8;
            color: #744210;
            border: 1px solid #fbd38d;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #4a5568;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .stat-card .number {
            color: #667eea;
            font-size: 2em;
            font-weight: bold;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 10px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .file-info {
            background: #f7fafc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .sync-status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .sync-status-synced {
            background: #c6f6d5;
            color: #22543d;
        }

        .sync-status-pending {
            background: #feebc8;
            color: #744210;
        }

        .sync-status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .backup-info {
            background: #ebf4ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .backup-info h4 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .backup-info p {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ IndexedDB + MySQL Sync</h1>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="connection-status">
                <span class="status-indicator online" id="statusIndicator"></span>
                <span id="statusText">Online - Terhubung ke MySQL</span>
            </div>
            <div class="pending-badge" id="pendingCount" style="display: none;">
                Pending: <span id="pendingNumber">0</span>
            </div>
        </div>

        <!-- Alert -->
        <div id="alert" class="alert"></div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 10px; color: white;">Loading...</p>
        </div>

        <!-- Progress Bar -->
        <div id="progressBar" class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card" onclick="showBackupInfo()">
                <h3>Total Users</h3>
                <div class="number" id="totalUsers">0</div>
            </div>
            <div class="stat-card" onclick="showBackupInfo()">
                <h3>Total Posts</h3>
                <div class="number" id="totalPosts">0</div>
            </div>
            <div class="stat-card" onclick="showBackupInfo()">
                <h3>Pending Sync</h3>
                <div class="number" id="totalPending">0</div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <button class="btn btn-primary" onclick="showAddUserModal()">
                ‚ûï Tambah User
            </button>

    
            <button class="btn btn-success" onclick="showAddPostModal()">
                üìù Tambah Post
            </button>
            <button class="btn btn-warning" onclick="refreshData()">
                üîÑ Refresh
            </button>
            <button class="btn btn-danger" onclick="backupDatabase()">
                üíæ Backup DB
            </button>
            <button class="btn btn-info" onclick="document.getElementById('restoreFile').click()">
                üìÇ Restore DB
            </button>
            <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreDatabase(this.files[0])">
            <button class="btn btn-purple" onclick="showExportModal()">
                üì§ Export/Import
            </button>
            <button class="btn btn-primary" onclick="forceSync()" id="syncButton">
                ‚ö° Sync Sekarang
            </button>
            <button class="btn btn-warning" onclick="testConnection()">
                üîå Test Koneksi MySQL
            </button>
            <button class="btn btn-info" onclick="pullFromMySQL()">
                üì• Ambil dari MySQL
            </button>
        </div>

        <!-- Users Card -->
        <div class="card">
            <div class="card-header">
                <h2>üë• Daftar Users</h2>
                <span class="badge" id="userCount">0</span>
            </div>
            <div style="overflow-x: auto;">
                <table class="table" id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Nama</th>
                            <th>Dibuat</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody">
                        <tr>
                            <td colspan="7" style="text-align: center;">Belum ada data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Posts Card -->
        <div class="card">
            <div class="card-header">
                <h2>üì∞ Daftar Posts</h2>
                <span class="badge" id="postCount">0</span>
            </div>
            <div style="overflow-x: auto;">
                <table class="table" id="postsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User ID</th>
                            <th>Judul</th>
                            <th>Konten</th>
                            <th>Dibuat</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="postsBody">
                        <tr>
                            <td colspan="7" style="text-align: center;">Belum ada data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Tambah User -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('userModal')">&times;</span>
            <h2 style="margin-bottom: 20px;">Tambah User Baru</h2>
            <form id="userForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required placeholder="kliwon">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" required placeholder="kliwon@example.com">
                </div>
                <div class="form-group">
                    <label>Nama Lengkap</label>
                    <input type="text" id="name" required placeholder="Kliwon bin Paing">
                </div>
                <button type="submit" class="btn btn-primary">Simpan</button>
                <button type="button" class="btn" onclick="closeModal('userModal')">Batal</button>
            </form>
        </div>
    </div>

    <!-- Modal Tambah Post -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('postModal')">&times;</span>
            <h2 style="margin-bottom: 20px;">Tambah Post Baru</h2>
            <form id="postForm">
                <div class="form-group">
                    <label>User ID</label>
                    <select id="userId" required>
                        <option value="">Pilih User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Judul</label>
                    <input type="text" id="title" required placeholder="Judul post">
                </div>
                <div class="form-group">
                    <label>Konten</label>
                    <textarea id="content" required rows="4" placeholder="Isi post..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Simpan</button>
                <button type="button" class="btn" onclick="closeModal('postModal')">Batal</button>
            </form>
        </div>
    </div>

    <!-- Modal Export/Import -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('exportModal')">&times;</span>
            <h2 style="margin-bottom: 20px;">üì§ Export / Import Data</h2>
            
            <div style="margin-bottom: 20px;">
                <h3>Export Data</h3>
                <p style="color: #666; margin-bottom: 10px;">Download semua data ke file JSON</p>
                <button class="btn btn-purple" onclick="exportAllData()">üì• Export Sekarang</button>
            </div>
            
            <div class="divider"></div>
            
            <div>
                <h3>Import Data</h3>
                <p style="color: #666; margin-bottom: 10px;">Upload file JSON untuk restore data</p>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="mergeData" checked>
                    <label for="mergeData">Gabungkan dengan data yang ada (jika tidak dicentang, data lama akan dihapus)</label>
                </div>
                
                <button class="btn btn-info" onclick="document.getElementById('importFile').click()">
                    üìÇ Pilih File Import
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this.files[0])">
            </div>
            
            <div class="file-info" id="fileInfo" style="display: none;">
                <strong>Info File:</strong>
                <p id="fileName"></p>
                <p id="fileSize"></p>
                <p id="fileContent"></p>
            </div>
        </div>
    </div>

    <!-- Modal Koneksi MySQL -->
    <div id="mysqlModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('mysqlModal')">&times;</span>
            <h2 style="margin-bottom: 20px;">üîå Konfigurasi Koneksi MySQL</h2>
            
            <div class="form-group">
                <label>Host</label>
                <input type="text" id="mysqlHost" value="localhost" placeholder="localhost">
            </div>
            <div class="form-group">
                <label>Port</label>
                <input type="text" id="mysqlPort" value="3306" placeholder="3306">
            </div>
            <div class="form-group">
                <label>Database</label>
                <input type="text" id="mysqlDB" value="hybrid_db" placeholder="hybrid_db">
            </div>
            <div class="form-group">
                <label>User</label>
                <input type="text" id="mysqlUser" value="root" placeholder="root">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="mysqlPass" value="P@ss1234" placeholder="P@ss1234">
            </div>
            
            <button class="btn btn-primary" onclick="saveMySQLConfig()">Simpan</button>
            <button class="btn btn-info" onclick="testMySQLConnection()">Test Koneksi</button>
            <button class="btn" onclick="closeModal('mysqlModal')">Tutup</button>
            
            <div id="mysqlTestResult" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
        </div>
    </div>

    <script>
        // ==================== KONFIGURASI ====================
       // const API_URL = 'http://localhost/api.php'; // Sesuaikan dengan URL API Anda

         const API_URL = 'http://preview.diskon.cloud/indexeddb/api.php'; 
        
        // Konfigurasi IndexedDB
        const DB_CONFIG = {
            name: 'KliwonPaingDB',
            version: 4,
            stores: {
                users: {
                    keyPath: 'id',
                    indexes: [
                        { name: 'email', keyPath: 'email', options: { unique: true } },
                        { name: 'username', keyPath: 'username', options: { unique: true } },
                        { name: 'syncStatus', keyPath: 'syncStatus', options: { unique: false } }
                    ]
                },
                posts: {
                    keyPath: 'id',
                    indexes: [
                        { name: 'userId', keyPath: 'userId', options: { unique: false } },
                        { name: 'createdAt', keyPath: 'createdAt', options: { unique: false } },
                        { name: 'syncStatus', keyPath: 'syncStatus', options: { unique: false } }
                    ]
                },
                pending_changes: {
                    keyPath: 'id',
                    indexes: [
                        { name: 'storeName', keyPath: 'storeName', options: { unique: false } },
                        { name: 'action', keyPath: 'action', options: { unique: false } },
                        { name: 'timestamp', keyPath: 'timestamp', options: { unique: false } }
                    ]
                }
            }
        };

        // ==================== SERVICE INDEXEDDB ====================
        class IndexedDBService {
            constructor(config) {
                this.config = config;
                this.db = null;
            }

            async connect() {
                if (this.db) return this.db;

                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.config.name, this.config.version);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Hapus object store lama jika ada
                        Object.entries(this.config.stores).forEach(([storeName, storeConfig]) => {
                            if (db.objectStoreNames.contains(storeName)) {
                                db.deleteObjectStore(storeName);
                            }
                        });
                        
                        // Buat ulang object stores
                        Object.entries(this.config.stores).forEach(([storeName, storeConfig]) => {
                            const store = db.createObjectStore(storeName, { 
                                keyPath: storeConfig.keyPath 
                            });

                            if (storeConfig.indexes) {
                                storeConfig.indexes.forEach(index => {
                                    store.createIndex(index.name, index.keyPath, index.options || {});
                                });
                            }
                        });
                    };
                });
            }

            async add(storeName, data) {
                await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async get(storeName, id) {
                await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, id) {
                await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);

                    request.onsuccess = () => resolve(id);
                    request.onerror = () => reject(request.error);
                });
            }

            async update(storeName, data) {
                await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(storeName) {
                await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async queryByIndex(storeName, indexName, value) {
                await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const index = store.index(indexName);
                    const request = index.getAll(value);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async backup() {
                const backup = {};
                await this.connect();
                
                for (const storeName of Object.keys(this.config.stores)) {
                    backup[storeName] = await this.getAll(storeName);
                }
                
                return backup;
            }

            async restore(backup, merge = false) {
                await this.connect();
                
                if (!merge) {
                    for (const storeName of Object.keys(this.config.stores)) {
                        await this.clear(storeName);
                    }
                }
                
                for (const [storeName, items] of Object.entries(backup)) {
                    if (this.config.stores[storeName]) {
                        for (const item of items) {
                            try {
                                if (merge) {
                                    const existing = await this.get(storeName, item[this.config.stores[storeName].keyPath]);
                                    if (existing) {
                                        await this.update(storeName, item);
                                    } else {
                                        await this.add(storeName, item);
                                    }
                                } else {
                                    await this.add(storeName, item);
                                }
                            } catch (error) {
                                console.warn(`Gagal restore item:`, item, error);
                            }
                        }
                    }
                }
            }
        }

        // ==================== SYNC MANAGER ====================
        class SyncManager {
            constructor(db, apiUrl) {
                this.db = db;
                this.apiUrl = apiUrl;
                this.isOnline = navigator.onLine;
                this.isSyncing = false;
                this.pendingChanges = [];
                this.mysqlConnected = false;
                this.lastSyncTime = null;
            }

            async init() {
                await this.loadPendingChanges();
                
                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());
                
                // Sync hanya jika ada pending dan online (setiap 30 detik)
                setInterval(() => {
                    if (this.isOnline && this.mysqlConnected && !this.isSyncing && this.pendingChanges.length > 0) {
                        this.sync();
                    }
                }, 10000);
                
                await this.testMySQLConnection();
            }

            async testMySQLConnection() {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(this.apiUrl + '?action=test', {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    
                    const result = await response.json();
                    this.mysqlConnected = result.success;
                    
                    if (this.mysqlConnected) {
                        updateStatus('online', 'Online - Terhubung ke MySQL');
                        console.log('MySQL connected:', result.message);
                    } else {
                        updateStatus('offline', 'Online - MySQL tidak terhubung');
                    }
                } catch (error) {
                    console.error('MySQL connection error:', error);
                    this.mysqlConnected = false;
                    updateStatus('offline', 'Online - MySQL tidak terhubung');
                }
                
                return this.mysqlConnected;
            }

            async  testInsertMySQL() {
    if (!syncManager.mysqlConnected) {
        showAlert('MySQL tidak terhubung! Test koneksi dulu.', 'error');
        return;
    }
    
    try {
        showLoading(true);
        
        // Buat data unik
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substring(2, 8);
        
        const testData = {
            id: 'test_' + timestamp + '_' + randomId,
            username: 'testuser_' + timestamp,
            email: 'test_' + timestamp + '@test.com',
            name: 'Test User ' + timestamp,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        console.log('üì§ Mencoba insert:', testData);
        
        // Kirim langsung ke API
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'add',
                store: 'users',
                data: testData
            })
        });
        
        const result = await response.json();
        console.log('üì• Response:', result);
        
        if (result.success) {
            showAlert('‚úÖ TEST BERHASIL! Data masuk ke MySQL', 'success');
            
            // Tanya apakah mau lihat di phpMyAdmin
            if (confirm('Lihat data di phpMyAdmin?')) {
                window.open('http://localhost/phpmyadmin', '_blank');
            }
        } else {
            showAlert('‚ùå Gagal: ' + result.message, 'error');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


            async handleOnline() {
                this.isOnline = true;
                await this.testMySQLConnection();
                
                if (this.mysqlConnected && this.pendingChanges.length > 0) {
                    showAlert('Kembali online! Sinkronisasi data...', 'success');
                    await this.sync();
                }
            }

            handleOffline() {
                this.isOnline = false;
                this.mysqlConnected = false;
                updateStatus('offline', 'Offline - Mode lokal');
                showAlert('Anda sedang offline. Perubahan akan disimpan lokal.', 'warning');
            }

            async loadPendingChanges() {
                this.pendingChanges = await this.db.getAll('pending_changes');
                updatePendingCount(this.pendingChanges.length);
            }

            async addPendingChange(storeName, action, data) {

    const change = {
        id: 'pending_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        storeName: storeName,
        action: action,
        data: data,
        timestamp: new Date().toISOString(),
        retryCount: 0,
        status: 'pending'
    };

    await this.db.add('pending_changes', change);

    // Reload pending ke memory
    await this.loadPendingChanges();

    // Update status lokal jadi pending
    const localData = await this.db.get(storeName, data.id);
    if (localData) {
        localData.syncStatus = 'pending';
        await this.db.update(storeName, localData);
    }

    // üöÄ LANGSUNG SYNC TANPA NUNGGU INTERVAL
    if (this.isOnline && this.mysqlConnected && !this.isSyncing) {
        console.log("AUTO SYNC LANGSUNG...");
        await this.sync();
    }
}

            async removePendingChange(changeId) {
                await this.db.delete('pending_changes', changeId);
                await this.loadPendingChanges();
            }

            async sync() {

                console.log("SYNC DIPANGGIL");
                if (this.isSyncing || !this.isOnline || !this.mysqlConnected) return;
                
                this.isSyncing = true;
                updateStatus('syncing', 'Menyinkronkan...');
                
                try {
                    const pending = await this.db.getAll('pending_changes');
                    pending.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    let successCount = 0;
                    
                    for (const change of pending) {
                        try {
                            const response = await fetch(this.apiUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    action: change.action,
                                    store: change.storeName,
                                    data: change.data
                                })
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                // Update status lokal menjadi synced
                                const localData = await this.db.get(change.storeName, change.data.id);
                                if (localData) {
                                    localData.syncStatus = 'synced';
                                    localData.lastSync = new Date().toISOString();
                                    await this.db.update(change.storeName, localData);
                                }
                                
                                await this.removePendingChange(change.id);
                                successCount++;
                            } else {
                                change.retryCount++;
                                if (change.retryCount >= 5) {
                                    change.status = 'failed';
                                    await this.db.update('pending_changes', change);
                                    
                                    // Update status lokal menjadi error
                                    const localData = await this.db.get(change.storeName, change.data.id);
                                    if (localData) {
                                        localData.syncStatus = 'error';
                                        await this.db.update(change.storeName, localData);
                                    }
                                } else {
                                    await this.db.update('pending_changes', change);
                                }
                            }
                        } catch (error) {
                            console.error('Sync error:', error);
                            change.retryCount++;
                            await this.db.update('pending_changes', change);
                        }
                    }
                    
                    if (successCount > 0) {
                        showAlert(`${successCount} perubahan berhasil disinkronkan!`, 'success');
                    }
                    
                    this.lastSyncTime = new Date();
                } catch (error) {
                    showAlert('Gagal sinkronisasi: ' + error.message, 'error');
                } finally {
                    this.isSyncing = false;
                    await this.testMySQLConnection();
                    await this.loadPendingChanges();

                       await loadUsers();
                        await loadPosts();
                }
            }

            async pullData() {
                try {
                    // Ambil data users dari server
                    const usersResponse = await fetch(this.apiUrl + '?action=get&store=users');
                    const usersResult = await usersResponse.json();
                    
                    if (usersResult.success && usersResult.data) {
                        for (const serverUser of usersResult.data) {
                            const localUser = await this.db.get('users', serverUser.id);
                            
                            if (!localUser) {
                                // Data baru dari server, tambahkan ke lokal
                                serverUser.syncStatus = 'synced';
                                await this.db.add('users', serverUser);
                            } else if (localUser.syncStatus === 'synced') {
                                // Update hanya jika statusnya synced (bukan pending)
                                if (new Date(serverUser.updatedAt) > new Date(localUser.updatedAt || 0)) {
                                    serverUser.syncStatus = 'synced';
                                    await this.db.update('users', serverUser);
                                }
                            }
                            // Jika pending, biarkan (data lokal lebih baru)
                        }
                    }
                    
                    // Ambil data posts dari server
                    const postsResponse = await fetch(this.apiUrl + '?action=get&store=posts');
                    const postsResult = await postsResponse.json();
                    
                    if (postsResult.success && postsResult.data) {
                        for (const serverPost of postsResult.data) {
                            const localPost = await this.db.get('posts', serverPost.id);
                            
                            if (!localPost) {
                                serverPost.syncStatus = 'synced';
                                await this.db.add('posts', serverPost);
                            } else if (localPost.syncStatus === 'synced') {
                                if (new Date(serverPost.updatedAt) > new Date(localPost.updatedAt || 0)) {
                                    serverPost.syncStatus = 'synced';
                                    await this.db.update('posts', serverPost);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Pull data failed:', error);
                }
            }
        }

        // ==================== INISIALISASI ====================
        const db = new IndexedDBService(DB_CONFIG);
        const syncManager = new SyncManager(db, API_URL);

        // ==================== UTILITY FUNCTIONS ====================
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showProgress(show = true, percent = 0) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (show) {
                progressBar.style.display = 'block';
                progressFill.style.width = percent + '%';
            } else {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function formatDate(date) {
            return new Date(date).toLocaleString('id-ID');
        }

        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator ' + status;
            statusText.textContent = text;
        }

        function updatePendingCount(count) {
            const pendingCount = document.getElementById('pendingCount');
            const pendingNumber = document.getElementById('pendingNumber');
            const totalPending = document.getElementById('totalPending');
            
            if (count > 0) {
                pendingCount.style.display = 'block';
                pendingNumber.textContent = count;
                totalPending.textContent = count;
            } else {
                pendingCount.style.display = 'none';
                totalPending.textContent = '0';
            }
        }

        function showBackupInfo() {
            alert(
                'üìÅ LOKASI BACKUP:\n\n' +
                'File backup tersimpan di folder DOWNLOADS komputer kamu.\n\n' +
                'üìÇ Format: JSON\n' +
                'üíæ Ukuran: Tergantung jumlah data\n\n' +
                'Tips:\n' +
                '‚Ä¢ Backup otomatis terdownload saat klik tombol Backup\n' +
                '‚Ä¢ Simpan file backup di tempat aman\n' +
                '‚Ä¢ Bisa direstore kapan saja pakai tombol Restore'
            );
        }

        function showExportModal() {
            document.getElementById('exportModal').style.display = 'block';
            document.getElementById('fileInfo').style.display = 'none';
        }

        function showMySQLModal() {
            document.getElementById('mysqlModal').style.display = 'block';
            document.getElementById('mysqlTestResult').style.display = 'none';
        }

        // ==================== FUNGSI AMBIL DATA DARI MYSQL ====================
        async function pullFromMySQL() {
            if (!syncManager.mysqlConnected) {
                showAlert('MySQL tidak terhubung. Cek koneksi dulu.', 'error');
                return;
            }
            
            try {
                showLoading(true);
                showProgress(true, 30);
                
                // Hapus data lokal lama
                await db.clear('users');
                await db.clear('posts');
                await db.clear('pending_changes');
                
                showProgress(true, 50);
                
                // Ambil users dari MySQL
                const usersResponse = await fetch(API_URL + '?action=get&store=users');
                const usersResult = await usersResponse.json();
                
                if (usersResult.success && usersResult.data) {
                    for (const user of usersResult.data) {
                        user.syncStatus = 'synced';
                        user.lastSync = new Date().toISOString();
                        await db.add('users', user);
                    }
                    showAlert(`Loaded ${usersResult.data.length} users from MySQL`, 'success');
                }
                
                showProgress(true, 70);
                
                // Ambil posts dari MySQL
                const postsResponse = await fetch(API_URL + '?action=get&store=posts');
                const postsResult = await postsResponse.json();
                
                if (postsResult.success && postsResult.data) {
                    for (const post of postsResult.data) {
                        post.syncStatus = 'synced';
                        post.lastSync = new Date().toISOString();
                        await db.add('posts', post);
                    }
                    showAlert(`Loaded ${postsResult.data.length} posts from MySQL`, 'success');
                }
                
                showProgress(true, 100);
                
                await refreshData();
                await syncManager.loadPendingChanges();
                
                setTimeout(() => showProgress(false), 500);
                
            } catch (error) {
                console.error('Pull from MySQL failed:', error);
                showAlert('Gagal ambil data dari MySQL: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== FUNGSI BUAT SAMPLE DATA (OFFLINE) ====================
        async function createSampleData() {
            const timestamp = Date.now();
            const random1 = Math.random().toString(36).substring(2, 10);
            const random2 = Math.random().toString(36).substring(2, 10);
            
            const sampleUser1 = {
                id: 'usr_' + timestamp + '_' + random1,
                username: 'kliwon',
                email: 'kliwon@gmail.com',
                name: 'Kliwon bin Paing',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                syncStatus: 'synced'
            };
            
            const sampleUser2 = {
                id: 'usr_' + (timestamp + 1) + '_' + random2,
                username: 'paing',
                email: 'paing@gmail.com',
                name: 'Paing bin Kliwon',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                syncStatus: 'synced'
            };
            
            await db.add('users', sampleUser1);
            await db.add('users', sampleUser2);
            
            await db.add('posts', {
                id: 'pst_' + timestamp + '_' + Math.random().toString(36).substring(2, 10),
                userId: sampleUser1.id,
                title: 'Salam dari Kliwon',
                content: 'Halo semua, ini Kliwon! Aku lagi belajar IndexedDB.',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                syncStatus: 'synced'
            });
            
            await db.add('posts', {
                id: 'pst_' + (timestamp + 2) + '_' + Math.random().toString(36).substring(2, 10),
                userId: sampleUser2.id,
                title: 'Salam dari Paing',
                content: 'Halo semua, ini Paing! Mantap sekali aplikasinya.',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                syncStatus: 'synced'
            });
            
            showAlert('Sample data Kliwon & Paing berhasil dibuat!', 'success');
        }

        // ==================== CRUD OPERATIONS ====================
        async function loadUsers() {
            try {
                const users = await db.getAll('users');
                const tbody = document.getElementById('usersBody');
                
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Belum ada data</td></tr>';
                } else {
                    tbody.innerHTML = users.map(user => {
                        let statusClass = 'sync-status-synced';
                        let statusText = 'Tersimpan';
                        
                        if (user.syncStatus === 'pending') {
                            statusClass = 'sync-status-pending';
                            statusText = 'Menunggu sync';
                        } else if (user.syncStatus === 'error') {
                            statusClass = 'sync-status-error';
                            statusText = 'Gagal sync';
                        }
                        
                        return `
                        <tr>
                            <td>${user.id ? user.id.substring(0, 8) : '???'}...</td>
                            <td>${user.username || '-'}</td>
                            <td>${user.email || '-'}</td>
                            <td>${user.name || '-'}</td>
                            <td>${user.createdAt ? formatDate(user.createdAt) : '-'}</td>
                            <td><span class="sync-status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-danger btn-small" onclick="deleteUser('${user.id}')" style="padding: 5px 10px;">Hapus</button>
                            </td>
                        </tr>
                    `}).join('');
                }
                
                document.getElementById('userCount').textContent = users?.length || 0;
                document.getElementById('totalUsers').textContent = users?.length || 0;
                
                const userSelect = document.getElementById('userId');
                if (userSelect) {
                    userSelect.innerHTML = '<option value="">Pilih User</option>' + 
                        (users || []).map(user => `<option value="${user.id}">${user.username} (${user.name})</option>`).join('');
                }
                
            } catch (error) {
                console.error('Load users error:', error);
                showAlert('Gagal load users: ' + error.message, 'error');
            }
        }

        async function loadPosts() {
            try {
                const posts = await db.getAll('posts');
                const tbody = document.getElementById('postsBody');
                
                if (!posts || posts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Belum ada data</td></tr>';
                } else {
                    tbody.innerHTML = posts.map(post => {
                        let statusClass = 'sync-status-synced';
                        let statusText = 'Tersimpan';
                        
                        if (post.syncStatus === 'pending') {
                            statusClass = 'sync-status-pending';
                            statusText = 'Menunggu sync';
                        } else if (post.syncStatus === 'error') {
                            statusClass = 'sync-status-error';
                            statusText = 'Gagal sync';
                        }
                        
                        return `
                        <tr>
                            <td>${post.id ? post.id.substring(0, 8) : '???'}...</td>
                            <td>${post.userId ? post.userId.substring(0, 8) : '???'}...</td>
                            <td>${post.title || '-'}</td>
                            <td>${post.content ? post.content.substring(0, 30) + (post.content.length > 30 ? '...' : '') : '-'}</td>
                            <td>${post.createdAt ? formatDate(post.createdAt) : '-'}</td>
                            <td><span class="sync-status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-danger btn-small" onclick="deletePost('${post.id}')" style="padding: 5px 10px;">Hapus</button>
                            </td>
                        </tr>
                    `}).join('');
                }
                
                document.getElementById('postCount').textContent = posts?.length || 0;
                document.getElementById('totalPosts').textContent = posts?.length || 0;
                
            } catch (error) {
                console.error('Load posts error:', error);
                showAlert('Gagal load posts: ' + error.message, 'error');
            }
        }

        async function refreshData() {
            showLoading(true);
            await Promise.all([loadUsers(), loadPosts()]);
            showLoading(false);
            showAlert('Data berhasil di-refresh!');
        }

        // ==================== USER OPERATIONS ====================
        function showAddUserModal() {
            document.getElementById('userModal').style.display = 'block';
            document.getElementById('userForm').reset();
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                id: 'usr_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                name: document.getElementById('name').value,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                syncStatus: 'pending'
            };

            try {
                showLoading(true);
                
                await db.add('users', userData);
                await syncManager.addPendingChange('users', 'add', userData);
                
                showAlert('User berhasil ditambahkan! ' + (syncManager.mysqlConnected ? '' : 'Akan disinkronkan saat online.'));
                closeModal('userModal');
                await loadUsers();
            } catch (error) {
                showAlert('Gagal menambah user: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        async function deleteUser(userId) {
            if (!confirm('Yakin ingin menghapus user ini?')) return;
            
            try {
                showLoading(true);
                
                const userPosts = await db.queryByIndex('posts', 'userId', userId);
                if (userPosts.length > 0) {
                    if (!confirm('User ini memiliki ' + userPosts.length + ' posts. Hapus juga semua posts-nya?')) {
                        return;
                    }
                    
                    for (const post of userPosts) {
                        await db.delete('posts', post.id);
                        await syncManager.addPendingChange('posts', 'delete', { id: post.id });
                    }
                }
                
                await db.delete('users', userId);
                await syncManager.addPendingChange('users', 'delete', { id: userId });
                
                showAlert('User berhasil dihapus! ' + (syncManager.mysqlConnected ? '' : 'Akan disinkronkan saat online.'));
                await refreshData();
            } catch (error) {
                showAlert('Gagal menghapus user: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== POST OPERATIONS ====================
        function showAddPostModal() {
            document.getElementById('postModal').style.display = 'block';
            document.getElementById('postForm').reset();
        }

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const postData = {
                id: 'pst_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                userId: document.getElementById('userId').value,
                title: document.getElementById('title').value,
                content: document.getElementById('content').value,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                syncStatus: 'pending'
            };

            try {
                showLoading(true);
                
                const user = await db.get('users', postData.userId);
                if (!user) {
                    throw new Error('User tidak ditemukan');
                }
                
                await db.add('posts', postData);
                await syncManager.addPendingChange('posts', 'add', postData);
                
                showAlert('Post berhasil ditambahkan! ' + (syncManager.mysqlConnected ? '' : 'Akan disinkronkan saat online.'));
                closeModal('postModal');
                await loadPosts();
            } catch (error) {
                showAlert('Gagal menambah post: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        async function deletePost(postId) {
            if (!confirm('Yakin ingin menghapus post ini?')) return;
            
            try {
                showLoading(true);
                await db.delete('posts', postId);
                await syncManager.addPendingChange('posts', 'delete', { id: postId });
                showAlert('Post berhasil dihapus! ' + (syncManager.mysqlConnected ? '' : 'Akan disinkronkan saat online.'));
                await loadPosts();
            } catch (error) {
                showAlert('Gagal menghapus post: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== BACKUP & RESTORE ====================
        async function backupDatabase() {
            try {
                showLoading(true);
                showProgress(true, 50);
                
                const backup = await db.backup();
                
                // Tambah metadata
                const backupData = {
                    version: DB_CONFIG.version,
                    backupDate: new Date().toISOString(),
                    appName: DB_CONFIG.name,
                    totalUsers: backup.users.length,
                    totalPosts: backup.posts.length,
                    data: backup
                };
                
                showProgress(true, 100);
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                //const exportFileDefaultName = 'db_backup_' + new Date().toISOString().replace(/[:.]/g, '-') + '.json';

                const now = new Date();
                const formatted =
                now.getFullYear() + '-' +
                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                String(now.getDate()).padStart(2, '0') + '_' +
                String(now.getHours()).padStart(2, '0') + '-' +
                String(now.getMinutes()).padStart(2, '0') + '-' +
                String(now.getSeconds()).padStart(2, '0');

                const exportFileDefaultName = 'backup_db_' + formatted + '.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showProgress(false);
                showAlert('‚úÖ Backup berhasil didownload!');
                
            } catch (error) {
                showProgress(false);
                showAlert('‚ùå Gagal backup: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function restoreDatabase(file) {
            if (!file) return;
            
            if (!confirm('‚ö†Ô∏è PERHATIAN: Restore akan menghapus semua data yang ada dan menggantinya dengan data backup. Lanjutkan?')) {
                return;
            }
            
            try {
                showLoading(true);
                showProgress(true, 10);
                
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        showProgress(true, 30);
                        
                        const backupData = JSON.parse(e.target.result);
                        const data = backupData.data || backupData;
                        
                        if (!data.users || !data.posts) {
                            throw new Error('Format file backup tidak valid!');
                        }
                        
                        showProgress(true, 50);
                        
                        await db.clear('users');
                        await db.clear('posts');
                        await db.clear('pending_changes');
                        
                        showProgress(true, 70);
                        
                        for (let i = 0; i < data.users.length; i++) {
                            data.users[i].syncStatus = 'synced';
                            await db.add('users', data.users[i]);
                            showProgress(true, 70 + (i / data.users.length) * 15);
                        }
                        
                        for (let i = 0; i < data.posts.length; i++) {
                            data.posts[i].syncStatus = 'synced';
                            await db.add('posts', data.posts[i]);
                        }
                        
                        showProgress(true, 100);
                        
                        showAlert(`‚úÖ Restore berhasil! ${data.users.length} users dan ${data.posts.length} posts di-restore.`);
                        
                        await refreshData();
                        await syncManager.loadPendingChanges();
                        
                        setTimeout(() => {
                            showProgress(false);
                        }, 1000);
                        
                    } catch (error) {
                        showProgress(false);
                        showAlert('‚ùå Gagal restore: ' + error.message, 'error');
                    } finally {
                        showLoading(false);
                    }
                };
                
                reader.readAsText(file);
                
            } catch (error) {
                showProgress(false);
                showAlert('‚ùå Gagal membaca file: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function exportAllData() {
            try {
                showLoading(true);
                
                const backup = await db.backup();
                
                const exportData = {
                    version: DB_CONFIG.version,
                    exportDate: new Date().toISOString(),
                    appName: DB_CONFIG.name,
                    totalUsers: backup.users.length,
                    totalPosts: backup.posts.length,
                    data: backup
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const fileName = `database_export_${new Date().toISOString().slice(0,10)}.json`;
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', fileName);
                link.click();
                
                showAlert(`‚úÖ Export sukses! ${backup.users.length} users, ${backup.posts.length} posts`);
                
            } catch (error) {
                showAlert('‚ùå Gagal export: ' + error.message, 'error');
            } finally {
                showLoading(false);
                closeModal('exportModal');
            }
        }

        async function importData(file) {
            if (!file) return;
            
            const mergeData = document.getElementById('mergeData').checked;
            
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileContent = document.getElementById('fileContent');
            
            fileName.textContent = `Nama: ${file.name}`;
            fileSize.textContent = `Ukuran: ${(file.size / 1024).toFixed(2)} KB`;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const imported = data.data || data;
                    const totalUsers = imported.users?.length || 0;
                    const totalPosts = imported.posts?.length || 0;
                    fileContent.textContent = `Isi: ${totalUsers} users, ${totalPosts} posts`;
                } catch {
                    fileContent.textContent = 'Isi: Format tidak valid';
                }
            };
            reader.readAsText(file);
            
            fileInfo.style.display = 'block';
            
            const confirmMsg = mergeData ? 
                '‚ö†Ô∏è Import akan MENGGABUNGKAN data dengan yang sudah ada. Lanjutkan?' :
                '‚ö†Ô∏è Import akan MENIMPA semua data yang ada. Lanjutkan?';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                showLoading(true);
                showProgress(true, 10);
                
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        showProgress(true, 30);
                        
                        let imported = JSON.parse(e.target.result);
                        const data = imported.data || imported;
                        
                        if (!data.users || !data.posts) {
                            throw new Error('Format file tidak valid!');
                        }
                        
                        showProgress(true, 50);
                        
                        if (!mergeData) {
                            await db.clear('users');
                            await db.clear('posts');
                            await db.clear('pending_changes');
                        }
                        
                        showProgress(true, 70);
                        
                        for (const user of data.users) {
                            user.syncStatus = mergeData ? 'pending' : 'synced';
                            if (mergeData) {
                                const existing = await db.get('users', user.id);
                                if (existing) {
                                    await db.update('users', user);
                                } else {
                                    await db.add('users', user);
                                }
                            } else {
                                await db.add('users', user);
                            }
                        }
                        
                        for (const post of data.posts) {
                            post.syncStatus = mergeData ? 'pending' : 'synced';
                            if (mergeData) {
                                const existing = await db.get('posts', post.id);
                                if (existing) {
                                    await db.update('posts', post);
                                } else {
                                    await db.add('posts', post);
                                }
                            } else {
                                await db.add('posts', post);
                            }
                        }
                        
                        showProgress(true, 100);
                        
                        await refreshData();
                        await syncManager.loadPendingChanges();
                        showAlert(`‚úÖ Import sukses! ${data.users.length} users, ${data.posts.length} posts`);
                        
                        setTimeout(() => {
                            showProgress(false);
                        }, 1000);
                        
                    } catch (error) {
                        showProgress(false);
                        showAlert('‚ùå Gagal import: ' + error.message, 'error');
                    } finally {
                        showLoading(false);
                        closeModal('exportModal');
                    }
                };
                
                reader.readAsText(file);
                
            } catch (error) {
                showProgress(false);
                showAlert('‚ùå Gagal import: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ==================== SYNC FUNCTIONS ====================
        async function forceSync() {
    showLoading(true);

    try {
        const connected = await syncManager.testMySQLConnection();

        if (!connected) {
            showAlert('MySQL tidak terhubung.', 'error');
            return;
        }

        await syncManager.sync();
        await refreshData();
    } catch (e) {
        console.error(e);
        showAlert('Gagal sync: ' + e.message, 'error');
    } finally {
        showLoading(false);
    }
}
        async function testConnection() {
            showLoading(true);
            await syncManager.testMySQLConnection();
            showLoading(false);
            
            if (syncManager.mysqlConnected) {
                showAlert('‚úÖ Koneksi MySQL berhasil!', 'success');
            } else {
                showAlert('‚ùå Koneksi MySQL gagal. Cek konfigurasi.', 'error');
                showMySQLModal();
            }
        }

        function saveMySQLConfig() {
            const config = {
                host: document.getElementById('mysqlHost').value,
                port: document.getElementById('mysqlPort').value,
                database: document.getElementById('mysqlDB').value,
                user: document.getElementById('mysqlUser').value,
                password: document.getElementById('mysqlPass').value
            };
            
            localStorage.setItem('mysqlConfig', JSON.stringify(config));
            showAlert('Konfigurasi disimpan!', 'success');
        }

        // ==================== INITIALIZATION ====================
        async function initDatabase() {
            showLoading(true);
            try {
                await db.connect();
                
                // Test koneksi MySQL dulu
                const mysqlConnected = await syncManager.testMySQLConnection();
                
                if (mysqlConnected) {
                    showAlert('Mengambil data dari MySQL...', 'success');
                    
                    // Ambil data dari MySQL
                    await pullFromMySQL();
                } else {
                    showAlert('MySQL tidak terhubung. Gunakan data sample Kliwon & Paing.', 'warning');
                    
                    // Jika offline, pake sample data
                    const users = await db.getAll('users');
                    if (users.length === 0) {
                        await createSampleData();
                    }
                }
                
                await syncManager.init();
                await refreshData();
                
                showAlert('Database siap! Mode: ' + (mysqlConnected ? 'Online - Data dari MySQL' : 'Offline - Data sample Kliwon & Paing'), 'success');
                
            } catch (error) {
                showAlert('Gagal inisialisasi: ' + error.message, 'error');
                console.error('Init error:', error);
            } finally {
                showLoading(false);
            }
        }

        // Load MySQL config dari localStorage
        function loadMySQLConfig() {
            const saved = localStorage.getItem('mysqlConfig');
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('mysqlHost').value = config.host || 'localhost';
                document.getElementById('mysqlPort').value = config.port || '3306';
                document.getElementById('mysqlDB').value = config.database || 'hybrid_db';
                document.getElementById('mysqlUser').value = config.user || 'root';
                document.getElementById('mysqlPass').value = config.password || 'P@ss1234';
            }
        }

        // Start the app
        loadMySQLConfig();
        initDatabase();

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
